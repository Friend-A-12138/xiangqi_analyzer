# 中国象棋AI分析器 - 项目总览

## 📋 项目简介

这是一个完整的中国象棋AI分析系统，基于深度学习和象棋引擎开发，支持多种输入方式和Web界面展示。

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Web界面层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   登录页面   │  │   主控制台   │  │   设置页面   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      API & SocketIO层                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  REST API   │  │  WebSocket  │  │  用户认证   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      核心业务逻辑层                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  象棋分析器  │  │  流处理器   │  │  内网穿透   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据输入层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  图片文件   │  │  RTMP流    │  │  屏幕截图   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 🎯 核心功能模块

### 1. 棋盘检测模块 (chess_analyzer.py)

**功能:**
- 姿态检测: 识别棋盘位置和角度
- 棋子分类: 识别棋子类型和颜色
- FEN生成: 转换为标准棋谱格式
- 引擎交互: 与Pikafish引擎通信

**类结构:**
```python
XiangqiAnalyzer
├── ChessboardDetector    # 棋盘检测器
│   ├── detect()          # 检测棋盘
│   └── _generate_mock_result()  # 生成模拟数据
├── PikafishEngine        # 象棋引擎
│   ├── start()           # 启动引擎
│   ├── get_best_move()   # 获取最佳走法
│   └── quit()            # 关闭引擎
└── format_analysis_result()  # 格式化结果
```

### 2. 流处理模块 (stream_processor.py)

**功能:**
- RTMP流处理: 从视频流中截取帧
- 模拟器截图: 自动检测和截取模拟器窗口
- 屏幕截图: 截取指定屏幕区域
- 窗口管理: 查找和管理系统窗口

**类结构:**
```python
RTMPStreamProcessor     # RTMP流处理器
├── start()             # 启动流处理
├── get_latest_frame()  # 获取最新帧
└── stop()              # 停止流处理

ScreenCapture           # 屏幕截图器
├── capture_window()    # 截取窗口
└── list_windows()      # 列出所有窗口

EmulatorCapture         # 模拟器截图器
├── capture()           # 截取模拟器画面
└── _find_emulator_window()  # 查找模拟器窗口
```

### 3. 内网穿透模块 (tunnel_service.py)

**功能:**
- ngrok集成: 使用ngrok实现内网穿透
- frp集成: 使用frp实现内网穿透
- 状态管理: 监控隧道状态
- URL管理: 获取和更新公网URL

**类结构:**
```python
TunnelManager           # 隧道管理器
├── setup_ngrok()       # 配置ngrok
├── setup_frp()         # 配置frp
├── start()             # 启动隧道
├── stop()              # 停止隧道
└── get_status()        # 获取状态

NgrokTunnel             # ngrok隧道
├── start()             # 启动ngrok
├── stop()              # 停止ngrok
└── _get_tunnel_info()  # 获取隧道信息

FrpTunnel               # frp隧道
├── start()             # 启动frp
├── stop()              # 停止frp
└── _create_config_file()  # 创建配置文件
```

### 4. Web界面模块 (app.py)

**功能:**
- 用户认证: 登录/登出管理
- REST API: 提供HTTP接口
- WebSocket: 实时通信
- 模板渲染: 动态生成HTML

**路由结构:**
```python
# 页面路由
/           -> 主页
/login      -> 登录页
/settings   -> 设置页
/logout     -> 登出

# API路由
/api/status     -> 获取状态
/api/config     -> 更新配置
/api/start      -> 开始分析
/api/stop       -> 停止分析
/api/result     -> 获取结果
/api/upload     -> 上传图片

# SocketIO事件
connect         -> 客户端连接
disconnect      -> 客户端断开
status          -> 状态更新
preview         -> 实时预览
analysis_result -> 分析结果
```

## 📊 数据流

### 单次分析流程

```
1. 用户上传图片/选择信号源
   ↓
2. 捕获图像帧
   ↓
3. 棋盘检测
   ↓
4. 棋子分类
   ↓
5. 生成FEN格式
   ↓
6. 发送给Pikafish引擎
   ↓
7. 获取推荐走法
   ↓
8. 格式化结果
   ↓
9. 通过WebSocket推送给前端
   ↓
10. 用户查看结果
```

### 实时分析流程

```
1. 用户启动分析
   ↓
2. 启动捕获线程
   ↓
3. 循环获取图像帧
   ↓
4. 定时触发分析
   ↓
5. 处理分析结果
   ↓
6. 推送结果到前端
   ↓
7. 用户实时查看
```

## 🔧 技术栈

### 后端技术

- **Python 3.7+**: 主要开发语言
- **OpenCV**: 图像处理和计算机视觉
- **NumPy**: 数值计算
- **Flask**: Web框架
- **Flask-SocketIO**: 实时通信
- **PyAutoGUI/MSS**: 屏幕截图

### 前端技术

- **HTML5/CSS3**: 页面结构和样式
- **JavaScript**: 交互逻辑
- **Bootstrap 5**: UI框架
- **Socket.IO Client**: 实时通信
- **jQuery**: DOM操作

### AI技术

- **深度学习模型**: 棋盘检测和棋子分类
- **Pikafish引擎**: 中国象棋AI引擎
- **UCI协议**: 与引擎通信的标准协议

## 📈 性能指标

### 响应时间

- 图片分析: 1-3秒
- 实时分析: 3-5秒/次
- 首次启动: 5-10秒

### 准确率

- 棋盘检测: >95%
- 棋子识别: >98%
- 走法推荐: 专业级

### 并发能力

- 同时在线用户: 5人（可配置）
- 分析频率: 0.2-1 Hz（可配置）

## 🛡️ 安全特性

### 认证授权

- 用户登录/登出
- Session管理
- 密码验证
- 用户数量限制

### 访问控制

- 内网穿透认证
- URL访问限制
- 用户权限管理

### 数据安全

- 本地处理，不上传数据
- 日志审计
- 配置加密存储

## 🎯 应用场景

### 1. 在线对局辅助

- 平台: JJ象棋、QQ象棋、天天象棋等
- 模式: 模拟器/屏幕截图
- 用途: 实时分析、学习AI思路

### 2. 棋谱批量分析

- 输入: 棋谱图片集
- 模式: 图片文件
- 用途: 研究经典棋局、棋谱整理

### 3. 教学演示

- 场景: 课堂、直播
- 模式: RTMP流
- 用途: 实时讲解、互动教学

### 4. 远程分析

- 方式: 内网穿透
- 特点: 随时随地访问
- 用途: 移动设备、异地协作

## 🚀 部署方案

### 单机部署

```
[本地机器]
├── 分析器服务 (5000端口)
├── Pikafish引擎
└── Web浏览器
```

### 局域网部署

```
[服务器:192.168.1.100]
├── 分析器服务 (5000端口)
└── Pikafish引擎

[客户端1] ←→ [客户端2] ←→ [客户端3]
     ↓           ↓           ↓
    浏览器      浏览器      浏览器
```

### 公网部署

```
[云服务器]
├── 分析器服务 (80端口)
├── Pikafish引擎
└── 内网穿透服务
     ↓
[公网用户] ←→ [公网URL]
```

## 📋 开发计划

### 已完成 ✓

- [x] 核心分析模块
- [x] 多种输入源支持
- [x] Web界面
- [x] 用户管理
- [x] 内网穿透
- [x] 完整文档

### 计划中 ⏳

- [ ] 移动端APP
- [ ] 语音播报
- [ ] 历史记录
- [ ] 棋谱数据库
- [ ] 多引擎支持
- [ ] 云端部署

## 🤝 贡献指南

### 代码贡献

1. Fork项目
2. 创建特性分支
3. 提交代码
4. 创建Pull Request

### 文档贡献

1. 完善使用文档
2. 添加示例配置
3. 翻译文档
4. 提交Issue

### 测试贡献

1. 测试不同平台
2. 测试不同场景
3. 报告Bug
4. 提供改进建议

## 📄 许可证

本项目采用MIT许可证。

## 📞 联系方式

- GitHub: [xiangqi-analyzer](https://github.com/yourusername/xiangqi-analyzer)
- Email: your.email@example.com
- QQ群: 123456789

---

**感谢使用中国象棋AI分析器！**